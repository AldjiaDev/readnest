<% content_for :title, "Librairies autour de moi" %>

<section class="container py-5" style="margin-top: 100px;">
  <h1 class="fw-bold mb-4 text-center">Librairies autour de moi</h1>

  <div id="map" style="height: 500px; border-radius: 1rem; overflow: hidden;"></div>

  <p class="text-muted small mt-3 text-center">
    Activez votre g√©olocalisation pour voir les librairies pr√®s de chez vous üìç
  </p>
</section>

<script>
  document.addEventListener("turbo:load", function () {
    const mapElement = document.getElementById("map");
    if (!mapElement) return;

    // Emp√™che de recr√©er la carte si elle existe d√©j√†
    if (window.mapInstance) {
      window.mapInstance.remove();
    }

    // Initialisation de la carte
    const map = L.map("map").setView([48.8566, 2.3522], 12); // Paris par d√©faut
    window.mapInstance = map;

    // Fond de carte OpenStreetMap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // G√©olocalisation utilisateur
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        // Marker utilisateur
        L.marker([userLat, userLng], {
          icon: L.icon({
            iconUrl: "https://cdn-icons-png.flaticon.com/512/64/64113.png",
            iconSize: [30, 30]
          })
        }).addTo(map).bindPopup("Vous √™tes ici").openPopup();

        map.setView([userLat, userLng], 14);

        // Requ√™te Overpass API : librairies √† 5km autour
        const query = `
          [out:json];
          node["shop"="books"](around:5000,${userLat},${userLng});
          out;
        `;

        fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query))
          .then(response => response.json())
          .then(data => {
            data.elements.forEach(function (el) {
              if (el.lat && el.lon) {
                const name = el.tags?.name || "Librairie inconnue";
                L.marker([el.lat, el.lon]).addTo(map)
                  .bindPopup("<strong>" + name + "</strong>");
              }
            });
          });
      });
    }
  });
</script>

