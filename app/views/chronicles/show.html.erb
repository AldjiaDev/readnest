<% content_for :title, @chronicle.title %>
<% content_for :meta_description, @chronicle.summary.presence || @chronicle.content.to_s.truncate(160) %>

<div class="chronicle-layout py-5">
  <div class="container" style="margin-top: 100px; max-width: 980px;">

    <!-- Bandeau meta magazine -->
    <div class="chronicle-meta-top d-flex flex-wrap justify-content-between align-items-center mb-3">
      <div class="d-flex flex-wrap align-items-center gap-2 small text-muted">
        <span class="badge rounded-pill bg-light border text-uppercase fw-semibold text-secondary">
          Chronique
        </span>
        <span class="badge rounded-pill bg-light border text-uppercase fw-semibold text-secondary">
          Littérature
        </span>
        <span class="ms-1">
          <%= l(@chronicle.created_at.to_date, format: :long) %> · 3 min de lecture
        </span>
      </div>
    </div>

    <!-- Bloc "hero" -->
    <header class="chronicle-hero mb-4">
      <!-- TITRE -->
      <h1 class="chronicle-title display-5 mb-3"><%= @chronicle.title %></h1>

      <!-- SOUS-TITRE / CHAPÔ -->
      <% if @chronicle.summary.present? %>
        <p class="chronicle-lead mb-4"><%= @chronicle.summary %></p>
      <% end %>

      <!-- AUTEUR + AVATAR -->
      <div class="d-flex align-items-center gap-3 mb-4">
        <% if @chronicle.user.avatar.attached? %>
          <%= image_tag url_for(@chronicle.user.avatar), class: "rounded-circle border", style: "width: 56px; height: 56px; object-fit: cover;" %>
        <% else %>
          <%= image_tag "default_avatar.png", class: "rounded-circle border", style: "width: 56px; height: 56px; object-fit: cover;" %>
        <% end %>

        <div class="small">
          <div class="fw-semibold">
            <%= link_to @chronicle.user.username, user_path(@chronicle.user), class: "text-decoration-none text-dark" %>
          </div>
          <div class="text-muted">Auteur · <%= l(@chronicle.created_at.to_date, format: :long) %></div>
        </div>
      </div>

      <!-- IMAGE PRINCIPALE -->
      <% if @chronicle.photo.attached? %>
        <figure class="chronicle-hero-image mb-0">
          <%= image_tag @chronicle.photo, class: "img-fluid w-100", style: "border-radius: 18px; object-fit: cover; max-height: 480px;" %>
          <figcaption class="text-muted small mt-2">
            <%= @chronicle.caption.presence || "Image fournie par l’auteur" %>
          </figcaption>
        </figure>
      <% end %>
    </header>

    <!-- Corps article + sidebar actions -->
    <div class="row g-5 mt-4">
      <div class="col-lg-8">

        <!-- TABLE DES MATIÈRES -->
        <% if @chronicle.table_of_contents.present? %>
          <div class="bg-light border rounded-3 p-3 mb-4 chronicle-toc">
            <h6 class="fw-bold mb-2 text-uppercase small text-muted">Table des matières</h6>
            <ul class="list-unstyled small mb-0">
              <% @chronicle.table_of_contents.each do |item| %>
                <li class="mb-1">• <%= item %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- CONTENU PRINCIPAL -->
        <article class="chronicle-article mb-5">
          <%= formatted_chronicle_content(@chronicle.content) %>
        </article>

        <!-- COMMENTAIRES -->
        <section class="chronicle-comments mt-5">
          <h4 class="mb-4 fw-bold border-bottom pb-2">Commentaires</h4>

          <% @chronicle.comments.where(parent_id: nil).order(created_at: :desc).each do |comment| %>
            <div class="mb-4 p-3 border rounded-3 bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong><%= comment.user.username %></strong>
                  <small class="text-muted">· il y a <%= time_ago_in_words(comment.created_at) %></small>
                </div>

                <% if user_signed_in? %>
                  <button class="btn btn-outline-dark btn-sm rounded-pill px-3"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#reply-form-<%= comment.id %>">
                    Répondre
                  </button>
                <% end %>
              </div>

              <p class="mt-2 mb-2"><%= comment.content %></p>

              <!-- Formulaire de réponse -->
              <div class="collapse mt-2" id="reply-form-<%= comment.id %>">
                <%= form_with model: [@chronicle, Comment.new], local: true do |f| %>
                  <%= f.hidden_field :parent_id, value: comment.id %>
                  <div class="mb-2">
                    <%= f.text_area :content, placeholder: "Votre réponse...", rows: 2, class: "form-control" %>
                  </div>
                  <div class="text-end">
                    <%= f.submit "Répondre", class: "btn btn-dark btn-sm rounded-pill px-3" %>
                  </div>
                <% end %>
              </div>

              <!-- Réponses -->
              <% if comment.replies.any? %>
                <div class="mt-3 ms-3 border-start ps-3">
                  <% comment.replies.order(created_at: :asc).each do |reply| %>
                    <div class="mb-2 p-2 border rounded-3 bg-white">
                      <strong><%= reply.user.username %></strong>
                      <small class="text-muted">· il y a <%= time_ago_in_words(reply.created_at) %></small>
                      <p class="mb-1"><%= reply.content %></p>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>

          <% if user_signed_in? %>
            <h5 class="mt-4">Ajouter un commentaire</h5>
            <%= form_with model: [@chronicle, Comment.new], local: true do |f| %>
              <div class="mb-2">
                <%= f.text_area :content, placeholder: "Votre commentaire...", rows: 3, class: "form-control" %>
              </div>
              <div class="text-end">
                <%= f.submit "Commenter", class: "btn btn-dark rounded-pill px-3" %>
              </div>
            <% end %>
          <% else %>
            <p class="text-muted">Connectez-vous pour commenter cette chronique.</p>
          <% end %>
        </section>
      </div>

      <!-- COLONNE DROITE : interactions & actions -->
      <div class="col-lg-4">
        <aside class="chronicle-sidebar">

          <!-- INTERACTIONS : J'AIME + FAVORI -->
          <div class="p-3 mb-4 border rounded-3 bg-white shadow-sm-sm">
            <h6 class="text-uppercase small text-muted mb-3">Votre interaction</h6>

            <div class="d-flex flex-column gap-2">
              <!-- J'AIME -->
              <div>
                <%= render "chronicles/like_button", chronicle: @chronicle %>
              </div>

              <!-- FAVORI -->
              <% if user_signed_in? %>
                <div>
                  <% if current_user.favorites.exists?(chronicle: @chronicle) %>
                    <%= button_to favorite_path(current_user.favorites.find_by(chronicle: @chronicle)),
                                  method: :delete,
                                  class: "btn btn-outline-warning btn-sm rounded-pill px-3 fw-semibold w-100 text-start" do %>
                      ★ Retirer des favoris
                    <% end %>
                  <% else %>
                    <%= button_to favorites_path(chronicle_id: @chronicle.id),
                                  method: :post,
                                  class: "btn btn-outline-dark btn-sm rounded-pill px-3 fw-semibold w-100 text-start" do %>
                      ☆ Ajouter aux favoris
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>

          <!-- PARTAGE SOCIAL -->
          <div class="p-3 mb-4 border rounded-3 bg-white shadow-sm-sm">
            <h6 class="text-uppercase small text-muted mb-3">Partager</h6>
            <div class="d-flex gap-2">
              <!-- Twitter/X -->
              <a href="https://twitter.com/intent/tweet?url=<%= request.original_url %>&text=<%= @chronicle.title %>"
                target="_blank" class="btn btn-sm btn-outline-dark rounded-circle d-flex align-items-center justify-content-center"
                style="width: 38px; height: 38px;">
                <i class="bi bi-twitter-x"></i>
              </a>

              <!-- LinkedIn -->
              <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= request.original_url %>"
                target="_blank" class="btn btn-sm btn-outline-dark rounded-circle d-flex align-items-center justify-content-center"
                style="width: 38px; height: 38px;">
                <i class="bi bi-linkedin"></i>
              </a>

              <!-- Facebook -->
              <a href="https://www.facebook.com/sharer/sharer.php?u=<%= request.original_url %>"
                target="_blank" class="btn btn-sm btn-outline-dark rounded-circle d-flex align-items-center justify-content-center"
                style="width: 38px; height: 38px;">
                <i class="bi bi-facebook"></i>
              </a>
            </div>
          </div>

          <!-- ACTIONS AUTEUR -->
          <% if current_user == @chronicle.user %>
            <div class="p-3 mb-4 border rounded-3 bg-white shadow-sm-sm">
              <h6 class="text-uppercase small text-muted mb-3">Actions</h6>
              <div class="d-flex flex-column gap-2">
                <%= link_to "Modifier",
                    edit_chronicle_path(@chronicle),
                    class: "btn btn-secondary btn-sm rounded-pill px-3 fw-semibold text-white text-start" %>

                <%= button_to "Supprimer",
                    chronicle_path(@chronicle),
                    method: :delete,
                    data: { confirm: "Supprimer définitivement cette chronique ?" },
                    class: "btn btn-danger btn-sm rounded-pill px-3 fw-semibold text-white text-start" %>
              </div>
            </div>
          <% end %>

          <!-- RETOUR -->
          <div class="text-center mt-3">
            <%= link_to "← Retour aux chroniques",
                chronicles_path,
                class: "btn btn-link text-decoration-none text-muted small" %>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<style>
  .chronicle-layout {
    background: #f3f4f6;
  }

  .chronicle-hero {
    border-bottom: 1px solid rgba(0,0,0,.04);
    padding-bottom: 1.5rem;
  }

  .chronicle-title {
    letter-spacing: -0.03em;
    line-height: 1.1;
  }

  .chronicle-lead {
    font-size: 1.1rem;
    color: #6c757d;
    max-width: 70ch;
    font-style: italic;
  }

  .chronicle-article {
    background: #ffffff;
    border-radius: 18px;
    padding: 2rem 2.25rem;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
    line-height: 1.9;
    font-size: 1.08rem;
  }

  .chronicle-article p {
    margin-bottom: 1.1rem;
  }

  .chronicle-article p:first-of-type::first-letter {
    float: left;
    font-size: 3rem;
    line-height: 1;
    padding-right: 0.25rem;
    padding-top: 0.15rem;
    font-weight: 700;
  }

  .chronicle-article h2,
  .chronicle-article h3 {
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    font-weight: 700;
  }

  .chronicle-article h2 {
    font-size: 1.4rem;
  }

  .chronicle-article h3 {
    font-size: 1.2rem;
  }

  .chronicle-article blockquote {
    border-left: 3px solid #000;
    padding-left: 1rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #555;
  }

  .chronicle-toc {
    border-style: dashed;
  }

  .chronicle-sidebar {
    position: sticky;
    top: 120px;
  }

  .shadow-sm-sm {
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
  }

  .chronicle-article blockquote {
  position: relative;
  margin: 2rem 0;
  padding: 1.25rem 1.5rem;
  border-left: 4px solid #000;
  background: #f8f9fb;
  border-radius: 12px;
  font-style: italic;
  color: #333;
}

.chronicle-article blockquote::before {
  content: "“";
  position: absolute;
  top: -16px;
  left: 10px;
  font-size: 3rem;
  color: rgba(0, 0, 0, 0.2);
  font-style: normal;
}

.chronicle-article blockquote::after {
  content: "”";
  position: absolute;
  bottom: -20px;
  right: 15px;
  font-size: 3rem;
  color: rgba(0, 0, 0, 0.2);
  font-style: normal;
}

.chronicle-article blockquote p {
  margin-bottom: 0;
  font-style: italic;
}


  @media (max-width: 991.98px) {
    .chronicle-sidebar {
      position: static;
      margin-top: 1rem;
    }
    .chronicle-article {
      padding: 1.5rem 1.4rem;
      border-radius: 12px;
    }
  }
</style>
