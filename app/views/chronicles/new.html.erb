<% content_for :title, "Nouvelle chronique" %>

<div class="container py-5 mt-5" style="max-width: 768px;">

  <!-- En-tête -->
  <div class="container py-5 mt-5" style="margin-top: 100px;">

    <h1 class="fw-bold display-5 text-black">Nouvelle chronique</h1>
    <p class="text-muted">Partagez vos impressions de lecture avec la communauté Readnest.</p>
  </div>

  <!-- Formulaire -->
  <%= form_with(model: @chronicle, local: true, html: { multipart: true }, class: "bg-white p-4 rounded-4 shadow-sm") do |form| %>
    <% if @chronicle.errors.any? %>
      <div class="alert alert-danger rounded-3">
        <h5 class="fw-bold mb-2"><%= pluralize(@chronicle.errors.count, "erreur") %> empêchent la sauvegarde :</h5>
        <ul class="mb-0">
          <% @chronicle.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Titre du livre -->
    <div class="mb-4">
      <%= form.label :book_title, "Titre du livre", class: "form-label fw-bold" %>
      <%= form.text_field :book_title, placeholder: "Ex. : L'Étranger", class: "form-control rounded-pill px-4 py-2" %>
    </div>

    <!-- Auteur -->
    <div class="mb-4">
      <%= form.label :author, "Auteur·e du livre", class: "form-label fw-bold" %>
      <%= form.text_field :author, placeholder: "Ex. : Albert Camus", class: "form-control rounded-pill px-4 py-2" %>
    </div>

    <!-- Maison d’édition -->
    <div class="mb-4">
      <%= form.label :publisher, "Maison d’édition", class: "form-label fw-bold" %>
      <%= form.text_field :publisher, placeholder: "Ex. : Gallimard", class: "form-control rounded-pill px-4 py-2" %>
    </div>

    <!-- Titre de la chronique -->
    <div class="mb-4">
      <%= form.label :title, "Titre de la chronique", class: "form-label fw-bold" %>
      <%= form.text_field :title, placeholder: "Ex. : Pourquoi Camus m’a bouleversé", class: "form-control rounded-pill px-4 py-2" %>
    </div>

    <!-- Résumé -->
    <div class="mb-4">
      <%= form.label :summary, "Introduction / Chapo", class: "form-label fw-bold" %>
      <%= form.text_area :summary, rows: 3, placeholder: "Quelques lignes résumant votre chronique...", class: "form-control rounded-3 px-3 py-2" %>
    </div>

        <!-- Contenu + citations (facultatif) -->
    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <%= form.label :content, "Contenu de la chronique", class: "form-label fw-bold mb-0" %>

        <!-- Bouton pour ajouter une citation (facultatif) -->
        <button type="button"
                class="btn btn-sm btn-outline-dark rounded-pill px-3"
                onclick="insertQuoteSyntax()">
          ➕ Ajouter une citation (facultatif)
        </button>
      </div>

      <div class="text-muted small mb-2">
        Les citations sont <strong>facultatives</strong> : cliquez sur le bouton pour insérer une citation mise en forme dans votre texte.
      </div>

      <%= form.text_area :content,
            rows: 10,
            placeholder: "Exprimez vos ressentis, vos analyses…",
            class: "form-control rounded-4 px-3 py-3",
            style: "line-height: 1.7;",
            id: "chronicle_content" %>

      <small class="form-text text-muted d-block mt-2">
        Astuce : vous pouvez aussi créer une citation en commençant une ligne par
        <code>&gt; Votre citation…</code>.
      </small>
    </div>


    <!-- Image -->
    <div class="mb-4">
      <%= form.label :photo, "Image associée", class: "form-label fw-bold" %>
      <%= form.file_field :photo, class: "form-control" %>
    </div>

    <!-- Bouton -->
    <div class="text-center mt-5">
      <%= form.submit "Publier ma chronique", class: "btn btn-dark rounded-pill px-4 py-2 text-uppercase fw-bold" %>
    </div>
  <% end %>

  <!-- Retour -->
  <div class="text-center mt-5">
    <%= link_to chronicles_path, class: "btn btn-outline-secondary px-4 py-2 rounded-pill shadow-sm fw-semibold" do %>
      Retour aux chroniques
    <% end %>
  </div>

</div>

<script>
  function setupBookAutocomplete() {
    const inputTitle = document.querySelector('input[name="chronicle[book_title]"]');
    const inputAuthor = document.querySelector('input[name="chronicle[author]"]');

    if (!inputTitle) return;
    console.log("✅ Autocomplétion initialisée");

    let suggestions = document.getElementById("book_suggestions");
    if (!suggestions) {
      suggestions = document.createElement("ul");
      suggestions.id = "book_suggestions";
      suggestions.className = "list-group position-absolute w-100 shadow-sm";
      suggestions.style = "z-index: 1000; display: none; max-height: 220px; overflow-y: auto;";
      inputTitle.parentNode.appendChild(suggestions);
    }

    inputTitle.addEventListener("input", async function () {
      const query = inputTitle.value.trim();
      if (query.length < 3) {
        suggestions.style.display = "none";
        return;
      }

      try {
        const response = await fetch(`https://openlibrary.org/search.json?title=${encodeURIComponent(query)}`);
        const data = await response.json();

        suggestions.innerHTML = "";
        data.docs.slice(0, 8).forEach(book => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action";
          const author = book.author_name ? book.author_name[0] : "Auteur inconnu";
          li.textContent = `${book.title} — ${author}`;
          li.addEventListener("click", function () {
            inputTitle.value = book.title;
            inputAuthor.value = author;
            suggestions.style.display = "none";
          });
          suggestions.appendChild(li);
        });

        suggestions.style.display = data.docs.length ? "block" : "none";
      } catch (error) {
        console.error("❌ Erreur API :", error);
      }
    });

    document.addEventListener("click", function (e) {
      if (!suggestions.contains(e.target) && e.target !== inputTitle) {
        suggestions.style.display = "none";
      }
    });
  }

  // Insérer une citation bien isolée dans le texte
  function insertQuoteSyntax() {
    const field = document.getElementById("chronicle_content");
    if (!field) return;

    const start = field.selectionStart;
    const end = field.selectionEnd;
    const value = field.value;

    const before = value.substring(0, start);
    const selected = value.substring(start, end) || "Votre citation ici";
    const after = value.substring(end);

    // On s'assure qu'il y a une ligne vide avant et après
    const needsLeadingNewlines =
      before.length > 0 && !before.endsWith("\n\n");
    const leading = needsLeadingNewlines ? "\n\n" : "";

    const insertion = `${leading}> ${selected}\n\n`;

    field.value = before + insertion + after;
    field.focus();

    const cursorPosition = (before + insertion).length;
    field.selectionStart = field.selectionEnd = cursorPosition;
  }

  document.addEventListener("turbo:load", setupBookAutocomplete);
  document.addEventListener("DOMContentLoaded", setupBookAutocomplete);
</script>

