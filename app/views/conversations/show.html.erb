<div class="container py-5" style="margin-top: 80px; max-width: 800px;">
  <h3 class="fw-bold mb-4 text-center">
    Conversation avec <%= @conversation.other_user(current_user).username %>
  </h3>

  <!-- Zone des messages -->
  <div id="messages" class="border rounded p-3 mb-4"
       style="max-height: 500px; overflow-y: auto; background-color: #f5f5f5;">

    <% @messages.each do |message| %>
      <div class="d-flex mb-3 <%= message.user == current_user ? 'justify-content-end' : 'justify-content-start' %>">

        <!-- Avatar si ce n’est pas moi -->
        <% if message.user != current_user %>
          <% if message.user.avatar.attached? %>
            <%= image_tag message.user.avatar, class: "rounded-circle me-2", style: "width: 35px; height: 35px; object-fit: cover;" %>
          <% else %>
            <%= image_tag "default_avatar.png", class: "rounded-circle me-2", style: "width: 35px; height: 35px; object-fit: cover;" %>
          <% end %>
        <% end %>

        <!-- Bulle style iPhone mais noire -->
        <div class="p-3 shadow-sm"
          style="
            max-width: 70%;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.4;
            <%= message.user == current_user ? 'background-color: #000; color: white; border-bottom-right-radius: 5px;' : 'background-color: #fff; color: black; border-bottom-left-radius: 5px;' %>
          ">
          <p class="mb-1"><%= message.content %></p>
          <small class="text-muted d-block text-end" style="font-size: 0.75rem;">
            <%= time_ago_in_words(message.created_at) %> ago
          </small>
        </div>

        <!-- Avatar si c’est moi -->
        <% if message.user == current_user %>
          <% if message.user.avatar.attached? %>
            <%= image_tag message.user.avatar, class: "rounded-circle ms-2", style: "width: 35px; height: 35px; object-fit: cover;" %>
          <% else %>
            <%= image_tag "default_avatar.png", class: "rounded-circle ms-2", style: "width: 35px; height: 35px; object-fit: cover;" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Formulaire en bas -->
  <%= form_with(model: [@conversation, @message], local: true) do |f| %>
    <div class="input-group">
      <%= f.text_area :content, class: "form-control rounded-start-pill shadow-sm", placeholder: "Écrire un message...", rows: 1, style: "resize:none;" %>
      <button class="btn btn-dark rounded-end-pill px-4" type="submit">Envoyer</button>
    </div>
  <% end %>
</div>

<script>
  // Auto-scroll vers le bas à chaque chargement
  document.addEventListener("turbo:load", () => {
    const messagesDiv = document.getElementById("messages");
    if (messagesDiv) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  });
</script>

