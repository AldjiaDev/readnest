<!-- Hero Section -->
<div class="position-relative text-white mb-5">
  <%= image_tag "hero_books.jpeg", class: "img-fluid w-100", style: "height: 450px; object-fit: cover;" %>
  <div class="position-absolute top-50 start-50 translate-middle text-center px-3">
    <h1 class="display-4 fw-bold text-white" style="text-shadow: 1px 1px 3px #000;">
      Chaque livre est une porte vers un autre monde
    </h1>
    <%= link_to "Commencer √† √©crire", new_chronicle_path, class: "btn btn-primary btn-lg mt-3" %>
  </div>
</div>

<!-- Barre de recherche -->
<div class="container my-4">
  <%= form_with url: root_path, method: :get, local: true, class: "row g-2 justify-content-center" do |form| %>
    <div class="col-md-6">
      <%= form.text_field :query, value: params[:query], placeholder: "Rechercher une chronique par titre, contenu ou auteur", class: "form-control" %>
    </div>
    <div class="col-auto">
      <%= form.submit "Rechercher", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<!-- Derni√®res chroniques -->
<div class="container my-5">
  <h2 class="mb-4 text-center text-brown">Derni√®res chroniques</h2>

  <% if @chronicles.empty? %>
    <div class="text-center text-muted my-5">
      <p>Aucune chronique trouv√©e pour cette recherche.</p>
    </div>
  <% end %>

  <div class="row">
    <% @chronicles.each do |chronicle| %>
      <%= render partial: "chronicles/card", locals: { chronicle: chronicle } %>
    <% end %>
  </div>
</div>

<!-- Top 10 des livres √† lire -->
<div class="container my-5">
  <h2 class="mb-4 text-center text-brown">Top 10 des livres √† lire</h2>

  <div id="booksCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <% top_books = [
        { title: "1984", author: "George Orwell", image: "1984.jpg" },
        { title: "Le Petit Prince", author: "Antoine de Saint-Exup√©ry", image: "le_petit_prince.jpg" },
        { title: "To Kill a Mockingbird", author: "Harper Lee", image: "mockingbird.jpg" },
        { title: "L'√âtranger", author: "Albert Camus", image: "etranger.jpg" },
        { title: "Les Mis√©rables", author: "Victor Hugo", image: "les_miserables.jpg" },
        { title: "The Great Gatsby", author: "F. Scott Fitzgerald", image: "gatsby.jpg" }
      ] %>

      <% top_books.each_slice(4).with_index do |group, i| %>
        <div class="carousel-item <%= 'active' if i == 0 %>">
          <div class="row justify-content-center">
            <% group.each do |book| %>
              <div class="col-6 col-sm-4 col-md-3 mb-4">
                <div class="card h-100 shadow-sm border-0" style="aspect-ratio: 2 / 3; overflow: hidden;">
                  <%= image_tag book[:image], class: "card-img-top", style: "height: 70%; object-fit: cover;" %>
                  <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1 fw-bold"><%= book[:title] %></h6>
                    <p class="card-text text-muted mb-0" style="font-size: 0.85rem;">par <%= book[:author] %></p>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#booksCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Pr√©c√©dent</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#booksCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Suivant</span>
    </button>
  </div>
</div>

<!-- Maisons d‚Äô√©dition -->
<section class="container my-5">
  <h2 class="text-center mb-4 fw-bold" style="color: #5e4636;">Maisons d‚Äô√©dition √† d√©couvrir</h2>

  <div class="row row-cols-1 row-cols-md-3 g-4">
    <% @publishing_houses.each do |house| %>
      <div class="col">
        <div class="card h-100 shadow-sm border-0" style="aspect-ratio: 2 / 3; overflow: hidden;">
          <% if house.logo.attached? %>
            <%= image_tag house.logo, class: "card-img-top", style: "height: 70%; object-fit: contain;" %>
          <% end %>
          <div class="card-body text-center p-3">
            <h5 class="card-title"><%= house.name %></h5>
            <p class="card-text text-muted small"><%= truncate(house.description, length: 100) %></p>
            <%= link_to "Voir la maison", publishing_house_path(house), class: "btn btn-outline-primary btn-sm mt-2" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="text-center mt-4">
    <%= link_to "Voir toutes les maisons d‚Äô√©dition", publishing_houses_path, class: "btn btn-primary" %>
  </div>
</section>

<!-- Carte : librairie proche -->
<div class="container my-5">
  <h2 class="mb-4 text-center text-brown">Trouver une librairie autour de vous</h2>
  <div id="map" style="height: 400px;" class="border rounded shadow-sm"></div>
</div>

<!-- Leaflet CDN -->
<%= stylesheet_link_tag "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css", crossorigin: "" %>
<%= javascript_include_tag "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js", crossorigin: "", defer: true %>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const map = L.map('map').setView([lat, lng], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng])
          .addTo(map)
          .bindPopup("üìç Vous √™tes ici")
          .openPopup();

        const query = `
          [out:json];
          (
            node["shop"="books"](around:5000, ${lat}, ${lng});
            way["shop"="books"](around:5000, ${lat}, ${lng});
            relation["shop"="books"](around:5000, ${lat}, ${lng});
          );
          out center;
        `;

        fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          body: query
        })
        .then(res => res.json())
        .then(data => {
          data.elements.forEach(el => {
            const name = el.tags?.name || "Librairie";
            const markerLat = el.lat || el.center?.lat;
            const markerLng = el.lon || el.center?.lon;

            if (markerLat && markerLng) {
              L.marker([markerLat, markerLng])
                .addTo(map)
                .bindPopup(`üìö ${name}`);
            }
          });
        })
        .catch(error => console.error("Erreur de r√©cup√©ration des librairies :", error));
      });
    } else {
      alert("La g√©olocalisation n‚Äôest pas support√©e.");
    }
  });
</script>
