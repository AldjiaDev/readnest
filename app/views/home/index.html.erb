<!-- Hero Section -->
<div class="position-relative mb-5">
  <%= image_tag "hero_books.jpeg", class: "img-fluid w-100", style: "height: 450px; object-fit: cover;" %>

  <!-- Overlay fonc√© translucide -->
  <div class="position-absolute top-0 start-0 w-100 h-100" style="background: rgba(0, 0, 0, 0.45);"></div>

  <!-- Texte centr√© -->
  <div class="position-absolute top-50 start-50 translate-middle text-center text-white px-3">
    <h1 class="display-4 fw-bold mb-3" style="text-shadow: 2px 2px 6px rgba(0,0,0,0.6);">
      Chaque livre est une porte vers un autre monde
    </h1>
    <%= link_to "Commencer √† √©crire", new_chronicle_path, class: "btn btn-lg btn-light shadow-sm px-4 py-2" %>
  </div>
</div>

<!-- Derni√®res chroniques -->
<div class="container my-5">
  <h2 class="mb-4 text-center text-primary fw-bold">Derni√®res chroniques</h2>

  <div class="row g-4">
    <% @chronicles.each do |chronicle| %>
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="card h-100 border-0 shadow-sm">
          <% if chronicle.photo.attached? %>
            <%= image_tag chronicle.photo, class: "card-img-top", style: "height: 220px; object-fit: cover;" %>
          <% else %>
            <div class="bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center" style="height: 220px;">
              <span class="text-muted fst-italic">Aucune image</span>
            </div>
          <% end %>

          <div class="card-body d-flex flex-column">
            <h5 class="card-title mb-2 text-dark"><%= truncate(chronicle.title, length: 50) %></h5>
            <p class="card-text text-muted mb-3" style="font-size: 0.95rem;"><%= truncate(chronicle.content, length: 100) %></p>
            <small class="text-muted mb-2">‚úçÔ∏è <%= chronicle.user.username %></small>
            <%= link_to "Lire la suite", chronicle_path(chronicle), class: "btn btn-outline-primary btn-sm mt-auto" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>


<!-- Top 10 des livres √† lire -->
<div class="container my-5">
  <div class="bg-white border rounded shadow-sm p-4">
    <h2 class="mb-4 text-center text-primary fw-bold">üìö Top 10 des livres √† lire</h2>
    <div class="row row-cols-2 row-cols-sm-3 row-cols-md-5 g-4">
      <% top_books = [
        { title: "1984", author: "George Orwell", image: "1984.jpg" },
        { title: "Le Petit Prince", author: "Antoine de Saint-Exup√©ry", image: "le_petit_prince.jpg" },
        { title: "To Kill a Mockingbird", author: "Harper Lee", image: "mockingbird.jpg" },
        { title: "L'√âtranger", author: "Albert Camus", image: "etranger.jpg" },
        { title: "Les Mis√©rables", author: "Victor Hugo", image: "les_miserables.jpg" },
        { title: "The Great Gatsby", author: "F. Scott Fitzgerald", image: "gatsby.jpg" },
      ] %>

      <% top_books.each do |book| %>
        <div class="col">
          <div class="card h-100 shadow-sm" style="border-radius: 8px;">
            <%= image_tag book[:image], class: "card-img-top", alt: book[:title], style: "height: 320px; object-fit: cover;" %>
            <div class="card-body p-2 text-center">
              <h6 class="card-title mb-1 fw-bold"><%= book[:title] %></h6>
              <p class="card-text text-muted mb-0" style="font-size: 0.85rem;">par <%= book[:author] %></p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>




<!-- üìç Librairies autour de vous -->
<div class="container my-5">
  <div class="bg-white border rounded shadow-sm p-4">
    <h2 class="text-center mb-3 text-primary fw-bold">Trouver une librairie autour de vous</h2>
    <div id="map" style="height: 400px;" class="rounded shadow-sm border"></div>
  </div>
</div>

<!-- Leaflet CDN -->
<%= stylesheet_link_tag "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css", crossorigin: "" %>
<%= javascript_include_tag "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js", crossorigin: "", defer: true %>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const map = L.map('map').setView([lat, lng], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng])
          .addTo(map)
          .bindPopup("üìç Vous √™tes ici")
          .openPopup();

        const query = `
          [out:json];
          (
            node["shop"="books"](around:5000, ${lat}, ${lng});
            way["shop"="books"](around:5000, ${lat}, ${lng});
            relation["shop"="books"](around:5000, ${lat}, ${lng});
          );
          out center;
        `;

        fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          body: query
        })
        .then(response => response.json())
        .then(data => {
          data.elements.forEach(element => {
            const name = element.tags?.name || "Librairie";
            const markerLat = element.lat || element.center?.lat;
            const markerLng = element.lon || element.center?.lon;

            if (markerLat && markerLng) {
              L.marker([markerLat, markerLng])
                .addTo(map)
                .bindPopup(`üìö ${name}`);
            }
          });
        })
        .catch(error => {
          console.error("Erreur lors de la r√©cup√©ration des librairies :", error);
        });
      }, function () {
        alert("Autorisez la g√©olocalisation pour afficher la carte.");
      });
    } else {
      alert("La g√©olocalisation n‚Äôest pas support√©e.");
    }
  });
</script>
