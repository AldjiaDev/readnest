<!-- Hero avec barre de recherche -->
<section class="position-relative text-white" style="height: 90vh; overflow: hidden;">
  <%= image_tag "hero_books.jpeg", class: "w-100 h-100 position-absolute top-0 start-0", style: "object-fit: cover; filter: brightness(60%);" %>
  <div class="position-absolute top-50 start-50 translate-middle text-center px-3">
    <h1 class="display-4 fw-bold mb-4" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.6);">Chaque livre est une porte vers un autre monde</h1>

    <%= form_with url: root_path, method: :get, local: true, class: "d-flex justify-content-center gap-2" do |form| %>
      <%= form.text_field :query, value: params[:query], placeholder: "Rechercher une chronique...", class: "form-control form-control-lg rounded-pill w-50 px-4 shadow-sm" %>
      <%= form.submit "Rechercher", class: "btn btn-primary btn-lg rounded-pill px-4" %>
    <% end %>

    <div class="mt-4">
      <%= link_to "Commencer √† √©crire", new_chronicle_path, class: "btn btn-outline-light btn-lg rounded-pill px-4 shadow-sm" %>
    </div>
  </div>
</section>

<!-- Derni√®res chroniques -->
<section class="container py-5">
  <h2 class="text-center mb-5 text-brown fw-bold">Derni√®res chroniques</h2>

  <% if @chronicles.empty? %>
    <p class="text-muted text-center">Aucune chronique trouv√©e.</p>
  <% else %>
    <div class="row row-cols-1 row-cols-md-3 g-4">
      <% @chronicles.each do |chronicle| %>
        <%= render partial: "chronicles/card", locals: { chronicle: chronicle } %>
      <% end %>
    </div>
  <% end %>
</section>

<!-- Top 10 livres √† lire -->
<section class="bg-light py-5">
  <div class="container">
    <h2 class="text-center mb-5 text-brown fw-bold">Top 10 des livres √† lire</h2>

    <div class="d-flex overflow-auto gap-4 px-2">
      <% top_books = [
        { title: "1984", author: "George Orwell", image: "1984.jpg" },
        { title: "Le Petit Prince", author: "Antoine de Saint-Exup√©ry", image: "le_petit_prince.jpg" },
        { title: "To Kill a Mockingbird", author: "Harper Lee", image: "mockingbird.jpg" },
        { title: "L'√âtranger", author: "Albert Camus", image: "etranger.jpg" },
        { title: "Les Mis√©rables", author: "Victor Hugo", image: "les_miserables.jpg" },
        { title: "The Great Gatsby", author: "F. Scott Fitzgerald", image: "gatsby.jpg" }
      ] %>

      <% top_books.each do |book| %>
        <div class="card border-0 shadow-sm rounded-4" style="min-width: 200px; aspect-ratio: 2/3;">
          <%= image_tag book[:image], class: "card-img-top rounded-top-4", style: "height: 70%; object-fit: cover;" %>
          <div class="card-body text-center">
            <h6 class="fw-bold mb-0"><%= book[:title] %></h6>
            <p class="text-muted small">par <%= book[:author] %></p>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</section>

<!-- Maisons d‚Äô√©dition -->
<section class="container py-5">
  <h2 class="text-center mb-5 text-brown fw-bold">Maisons d‚Äô√©dition √† d√©couvrir</h2>
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <% @publishing_houses.each do |house| %>
      <div class="col">
        <div class="card h-100 shadow-sm border-0 rounded-4">
          <% if house.logo.attached? %>
            <%= image_tag house.logo, class: "card-img-top p-4", style: "height: 200px; object-fit: contain;" %>
          <% end %>
          <div class="card-body text-center">
            <h5 class="fw-bold"><%= house.name %></h5>
            <p class="text-muted small"><%= truncate(house.description, length: 100) %></p>
            <%= link_to "Voir la maison", publishing_house_path(house), class: "btn btn-outline-primary btn-sm mt-2" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  <div class="text-center mt-4">
    <%= link_to "Voir toutes les maisons", publishing_houses_path, class: "btn btn-primary px-4 rounded-pill" %>
  </div>
</section>

<!-- Carte : Librairie proche -->
<section class="container py-5">
  <h2 class="text-center mb-4 text-brown fw-bold">Trouver une librairie autour de vous</h2>
  <div id="map" style="height: 400px;" class="border rounded-4 shadow-sm"></div>
</section>

<%= stylesheet_link_tag "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css", crossorigin: "" %>
<%= javascript_include_tag "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js", defer: true %>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const map = L.map('map').setView([lat, lng], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng])
          .addTo(map)
          .bindPopup("üìç Vous √™tes ici")
          .openPopup();

        const query = `
          [out:json];
          (
            node["shop"="books"](around:5000, ${lat}, ${lng});
            way["shop"="books"](around:5000, ${lat}, ${lng});
            relation["shop"="books"](around:5000, ${lat}, ${lng});
          );
          out center;
        `;

        fetch("https://overpass-api.de/api/interpreter", {
          method: "POST",
          body: query
        })
        .then(res => res.json())
        .then(data => {
          data.elements.forEach(el => {
            const name = el.tags?.name || "Librairie";
            const markerLat = el.lat || el.center?.lat;
            const markerLng = el.lon || el.center?.lon;

            if (markerLat && markerLng) {
              L.marker([markerLat, markerLng])
                .addTo(map)
                .bindPopup(`üìö ${name}`);
            }
          });
        })
        .catch(error => console.error("Erreur de r√©cup√©ration des librairies :", error));
      });
    } else {
      alert("La g√©olocalisation n‚Äôest pas support√©e.");
    }
  });
</script>
